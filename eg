# 1. StatefulSet для Kafka-клиента (обновленный)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka-client
spec:
  serviceName: "kafka-client"
  replicas: 4
  selector:
    matchLabels:
      app: kafka-client
  template:
    metadata:
      labels:
        app: kafka-client
      annotations:
        k8s.v1.cni.cncf.io/networks: '[
          {
            "name": "egress-network",
            "interface": "eth1"
          }
        ]'
    spec:
      hostname: kafka-client
      subdomain: example-subdomain
      containers:
      - name: kafka-client
        image: confluentinc/cp-kafka:latest
        env:
        - name: KAFKA_OPTS
          value: "-Djava.security.krb5.conf=/etc/krb5.conf"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: EGRESS_IP
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['k8s.v1.cni.cncf.io/networks-status']
        command:
        - "/bin/bash"
        - "-c"
        - |
          EGRESS_IP=$(echo $EGRESS_IP | jq -r '.[1].ips[0]')
          echo "$POD_IP $(hostname).example-subdomain.default.svc.cluster.local" >> /etc/hosts
          echo "$EGRESS_IP $(hostname)-egress.example-subdomain.default.svc.cluster.local" >> /etc/hosts
          exec kafka-console-consumer ...  # Ваша команда запуска Kafka-клиента
        volumeMounts:
        - name: krb5-conf
          mountPath: /etc/krb5.conf
          subPath: krb5.conf
        - name: kafka-client-keytab
          mountPath: /etc/kafka/kafka-client.keytab
          subPath: kafka-client.keytab
        - name: client-properties
          mountPath: /etc/kafka/client.properties
          subPath: client.properties

---
# 2. Multus NetworkAttachmentDefinition для egress сети
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: egress-network
spec:
  config: '{
    "cniVersion": "0.3.1",
    "type": "macvlan",
    "master": "eth1",
    "mode": "bridge",
    "ipam": {
      "type": "host-local",
      "subnet": "192.168.1.0/24",
      "rangeStart": "192.168.1.200",
      "rangeEnd": "192.168.1.250",
      "routes": [
        { "dst": "192.168.2.0/24" }
      ],
      "gateway": "192.168.1.1"
    }
  }'

---
# 3. ConfigMap для client.properties (обновленный)
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-client-properties
data:
  client.properties: |
    security.protocol=SASL_PLAINTEXT
    sasl.mechanism=GSSAPI
    sasl.kerberos.service.name=kafka
    sasl.jaas.config=com.sun.security.auth.module.Krb5LoginModule required \
      useKeyTab=true \
      storeKey=true \
      keyTab="/etc/kafka/kafka-client.keytab" \
      principal="kafka-client/$(hostname)-egress.example-subdomain.default.svc.cluster.local@EXAMPLE.COM";

---
# 4. ConfigMap для krb5.conf (обновленный)
apiVersion: v1
kind: ConfigMap
metadata:
  name: krb5-conf
data:
  krb5.conf: |
    [libdefaults]
    default_realm = EXAMPLE.COM
    dns_lookup_realm = false
    dns_lookup_kdc = false

    [realms]
    EXAMPLE.COM = {
        kdc = 192.168.2.2
        admin_server = 192.168.2.2
    }

    [domain_realm]
    .example-subdomain.default.svc.cluster.local = EXAMPLE.COM
    example-subdomain.default.svc.cluster.local = EXAMPLE.COM

---
# 5. Network Policy для доступа к внешнему KDC и Kafka кластеру
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-kdc-and-kafka
spec:
  podSelector:
    matchLabels:
      app: kafka-client
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 192.168.2.0/24
    ports:
    - protocol: TCP
      port: 88
    - protocol: UDP
      port: 88
    - protocol: TCP
      port: 749
    - protocol: TCP
      port: 9093

---
# 6. CoreDNS ConfigMap для настройки DNS (обновленный)
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
data:
  example-subdomain.server: |
    example-subdomain.default.svc.cluster.local:53 {
        errors
        cache 30
        forward . 10.0.0.2
    }
  1.168.192.in-addr.arpa.server: |
    1.168.192.in-addr.arpa:53 {
        errors
        cache 30
        forward . 10.0.0.2
    }
